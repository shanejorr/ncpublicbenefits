---
title: "ncpublicbenefits"
author: "Shane Orr"
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# ncpublicbenefits

<!-- badges: start -->
<!-- badges: end -->

`ncpublicbenefits` is an R package that creates tables of benefit levels for various income and family types. This lets you see how benefits change as income changes â€“ in other words, the benefits cliff in action. Note that the purpose is not to calculate a family's exact benefit amount at a given income level. Instead, the functions create a table using typical assumptions; thus, the benefit amounts are estimates that demonstrate overall trends rather than precise values.

The package provides an example of how you can use R to calculate benefit levels and total take-home pay. The package uses data for Forsyth County, North Carolina in 2019. But, the code can easily be updated to use data from other counties or years.

## Installation

To install `ncpublicbenefits`:

```{r}
# Install using devtools (if not already installed)
# install.packages("devtools")
# devtools::install_github("shanejorr/ncpublicbenefits")
```

## Examples
Below are some examples showing how to use the functions. For a full demonstration, see the create_datasets.R file.

### Creating a Comprehensive Benefits Table
The main function `create_benefits_table` calculates all benefit tables (e.g., child care, SNAP/FNS, housing vouchers, Medicaid, and TANF) for multiple income levels and family types.

```{r} 
library(ncpublicbenefits)
library(ggplot2)
library(dplyr)
library(tidyr)

# Create a comprehensive benefits table
benefits_table <- create_benefits_table(100)

# View the structure of the table
print(head(benefits_table))
```

This table aggregates benefit data across family compositions and incomes to help visualize benefit cliffs when plotted.

## Calculating Benefits for a Single Benefit

You can also calculate a table for a single benefit. For example, the `fns_snap` function calculates FNS (SNAP) benefits based on a base table generated by `base_composition`.

```{r}
# Create the base composition table 
base_tbl <- base_composition()

# Calculate only FNS (Food Stamps) benefit
snap_benefits <- fns_snap(base_tbl)

# Print first few rows of the FNS benefit table
print(head(snap_benefits))
```

### Using Other Benefit Functions

Similarly, you can compute individual benefit tables such as child care subsidy benefits with the `child_care` function.

```{r}
# Calculate child care subsidy benefits
child_care_benefits <- child_care(base_tbl)

# Print the resulting table
print(head(child_care_benefits))
```

## Total Take-Home Income Calculation

The [`total_take_home_income`](R/create_datasets.R) function is designed to create a table that shows the total take-home pay for a household. It does this by combining the household's income, subtracting taxes, and then adding any applicable benefits. This lets you visualize how the total take-home income changes across different income levels.

For example, if you have a benefits table (generated by [`create_benefits_table`](R/create_datasets.R)) and wish to compare the income minus taxes versus the adjusted take-home income (i.e. income plus benefits, minus taxes) for a specific family composition and a selection of benefits, you can use the function as follows:

```{r}
# Select a specific family composition and a set of benefit types
unique_composition <- family_benefit_values('family')[3]
unique_benefits <- family_benefit_values('benefits')[1:3]

# Calculate total take-home income for the selected family and benefits,
# where total take-home income = monthly income - taxes + total benefit
take_home_table <- total_take_home_income(benefits_table, unique_composition, unique_benefits)

print(head(take_home_table))
```

In this example, the [`total_take_home_income`](R/create_datasets.R) function creates a summary table showing, for each income level, both the "Income minus taxes" and the "Income plus benefits, minus taxes." This helps you see how additional benefits impact the overall take-home pay across a range of incomes. 

## Visualizations

Once you have the benefit tables, you can visualize the benefits cliff.

```{r}
benefits_single_family_type <- benefits_table |>
    filter(composition == !!unique_composition)

ggplot(benefits_single_family_type, aes(x = monthly_income, y = payment, color = benefit)) +
    geom_line() +
    labs(
      title = "Benefit levels by income",
      subtitle = paste0("Family type: ", unique_composition),
      x = "Monthly Income",
      y = "Benefit Amount",
      color = NULL
    ) +
    scale_x_continuous(labels = scales::dollar_format()) +
    scale_y_continuous(labels = scales::dollar_format()) +
    theme_minimal() +
    theme(legend.position = "bottom")
```

You can also look at how total take-home income (income plus benefits minus taxes) changes with income.

```{r}
income_plus_benefits <- take_home_table |>
    select(monthly_income, income_minus_taxes, take_home) |>
    pivot_longer(cols = c('income_minus_taxes', 'take_home'), names_to = 'pay_type', values_to = 'income') |>
    mutate(
      pay_type = case_match(
        .data$pay_type,
        'income_minus_taxes' ~ 'Income minus taxes',
        'take_home' ~ 'Income plus benefits, minus taxes'
      )
    ) |>
    arrange(.data$pay_type, .data$monthly_income)

ggplot(income_plus_benefits, aes(x = monthly_income, y = income, color = pay_type)) +
  geom_line() +
  labs(
    title = "Total take home income by wage",
    subtitle = paste0("Family type: ", unique_composition),
    x = "Monthly wage income",
    y = "Total take home income",
    caption = paste0("Benefits:\n", paste(unique_benefits, collapse = ", ")),
    color = NULL
  ) +
  scale_x_continuous(labels = scales::dollar_format()) +
  scale_y_continuous(labels = scales::dollar_format()) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.position = "bottom"
  )
```

## Purpose

The primary goal of `ncpublicbenefits` is to build datasets that show how benefit levels vary with income and family composition. This visualizes the benefits cliff and provides insight into policy impacts across different scenarios. Remember, the package makes standard assumptions and is not intended to predict the exact benefit each family would receive.
